<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Case Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
/* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --navy:      #0f1f3d;
  --blue:      #1a3a6b;
  --mid:       #2e5fa3;
  --accent:    #c8a84b;
  --light:     #e8eef8;
  --lighter:   #f4f7fd;
  --white:     #ffffff;
  --text:      #1a2540;
  --muted:     #6b7a99;
  --danger:    #c0392b;
  --success:   #1e7e4a;
  --overdue:   #8b1a1a;
  --due-soon:  #7d4e00;
  --shadow:    0 4px 24px rgba(15,31,61,0.10);
  --radius:    8px;
}

body {
  font-family: 'Source Sans 3', sans-serif;
  background: var(--lighter);
  color: var(--text);
  font-size: 13.5px;
  min-height: 100vh;
}

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  background: linear-gradient(135deg, var(--navy) 0%, var(--blue) 60%, #1d4080 100%);
  padding: 0 32px;
  display: flex; align-items: center; justify-content: space-between;
  height: 68px;
  box-shadow: 0 2px 20px rgba(15,31,61,0.35);
  position: sticky; top: 0; z-index: 50;
}

.header-left { display: flex; align-items: center; gap: 16px; }

.header-emblem {
  width: 38px; height: 38px;
  background: var(--accent);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
  box-shadow: 0 0 0 3px rgba(200,168,75,0.25);
  flex-shrink: 0;
}

header h1 {
  font-family: 'Playfair Display', serif;
  font-size: 19px;
  color: var(--white);
  letter-spacing: 0.3px;
}
header p { font-size: 11px; color: rgba(255,255,255,0.55); margin-top: 1px; letter-spacing: 0.2px; }

.header-right { display: flex; align-items: center; gap: 10px; }

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 7px 16px; border-radius: var(--radius);
  border: none; cursor: pointer;
  font-family: 'Source Sans 3', sans-serif;
  font-size: 12.5px; font-weight: 600;
  transition: all 0.15s ease;
  white-space: nowrap;
}
.btn-primary  { background: var(--mid);     color: var(--white); }
.btn-primary:hover  { background: var(--blue); transform: translateY(-1px); box-shadow: 0 3px 10px rgba(46,95,163,0.3); }
.btn-gold     { background: var(--accent);  color: var(--navy);  }
.btn-gold:hover     { background: #b8952e;  transform: translateY(-1px); box-shadow: 0 3px 10px rgba(200,168,75,0.3); }
.btn-ghost    { background: rgba(255,255,255,0.1); color: var(--white); border: 1px solid rgba(255,255,255,0.2); }
.btn-ghost:hover    { background: rgba(255,255,255,0.2); }
.btn-danger   { background: var(--danger);  color: var(--white); font-size: 11px; padding: 4px 10px; }
.btn-danger:hover   { background: #a93226; }
.btn-add-task { background: var(--light);   color: var(--blue);  font-size: 11px; padding: 4px 10px; border: 1px solid var(--mid); }
.btn-add-task:hover { background: #d4dfef; }
.btn-sm       { padding: 4px 10px; font-size: 11px; }

/* â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar {
  background: var(--white);
  padding: 10px 32px;
  display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
  border-bottom: 1.5px solid var(--light);
  box-shadow: 0 2px 8px rgba(15,31,61,0.05);
}

.toolbar-group { display: flex; align-items: center; gap: 8px; }
.toolbar label { font-weight: 700; color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }

select, input[type="text"] {
  border: 1.5px solid #d0daea; border-radius: 6px;
  padding: 6px 10px; font-size: 12.5px;
  font-family: 'Source Sans 3', sans-serif;
  background: var(--lighter); color: var(--text);
  outline: none; transition: border-color 0.2s;
}
select:focus, input:focus { border-color: var(--mid); background: white; }

.toolbar-right { margin-left: auto; display: flex; gap: 8px; }

/* â”€â”€ Status bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#statusBar {
  padding: 8px 32px;
  font-size: 12px; color: var(--muted);
  background: var(--lighter);
  border-bottom: 1px solid var(--light);
  display: flex; align-items: center; gap: 8px;
  min-height: 34px;
}
.status-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--success); flex-shrink: 0;
}
.status-dot.loading { background: var(--accent); animation: pulse 1s infinite; }
.status-dot.error   { background: var(--danger); }

@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* â”€â”€ Setup Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#setupBanner {
  display: none;
  margin: 20px 32px;
  background: #fff8e6;
  border: 1.5px solid var(--accent);
  border-radius: var(--radius);
  padding: 20px 24px;
}
#setupBanner h3 { color: var(--navy); font-family: 'Playfair Display', serif; margin-bottom: 8px; }
#setupBanner p  { color: var(--text); font-size: 13px; line-height: 1.6; }
#setupBanner code {
  background: var(--lighter); border: 1px solid var(--light);
  padding: 2px 6px; border-radius: 4px; font-size: 12px; word-break: break-all;
}
.setup-url-row { display: flex; gap: 10px; align-items: center; margin-top: 12px; flex-wrap: wrap; }
#scriptUrlInput { flex: 1; min-width: 280px; font-size: 12px; }

/* â”€â”€ Main content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.container { padding: 24px 32px; }

/* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap {
  background: var(--white);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--shadow);
  border: 1px solid var(--light);
}

table { width: 100%; border-collapse: collapse; }

.thead-section th {
  padding: 7px 12px; font-size: 10.5px; font-weight: 700;
  letter-spacing: 0.8px; text-transform: uppercase;
}
.th-case-section { background: var(--blue);  color: white; }
.th-task-section { background: #17375e;       color: white; }
.th-act-section  { background: var(--navy);   color: white; }

.thead-cols th {
  padding: 10px 12px; font-size: 11.5px; font-weight: 700;
  letter-spacing: 0.3px; white-space: nowrap;
  border-bottom: 2px solid rgba(255,255,255,0.15);
}
.th-case { background: var(--blue);  color: rgba(255,255,255,0.9); }
.th-task { background: #17375e;       color: rgba(255,255,255,0.9); }
.th-act  { background: var(--navy);   color: rgba(255,255,255,0.9); }

tbody tr { border-bottom: 1px solid #eaeff8; transition: filter 0.1s; }
tbody tr:last-child { border-bottom: none; }
tbody tr:hover:not(.task-done) { filter: brightness(0.97); }

td {
  padding: 8px 12px; vertical-align: middle;
}

.td-case-a { background: var(--white); }
.td-case-b { background: #f7f9fd; }
.td-task-a { background: #ebf0fb; }
.td-task-b { background: #f0f4fc; }
.td-act    { background: var(--lighter); white-space: nowrap; text-align: center; }

.task-done td { opacity: 0.55; }
.task-done td .td-task-a,
.task-done td .td-task-b { background: #e8f5ee !important; text-decoration: line-through; }

.client-name-cell { font-weight: 700; color: var(--navy); }

/* editable inputs */
input.editable {
  border: none; background: transparent;
  width: 100%; font-family: 'Source Sans 3', sans-serif;
  font-size: 13.5px; color: inherit; outline: none;
}
input.editable:focus {
  background: rgba(255,255,255,0.85);
  border-bottom: 1.5px solid var(--mid);
  padding-bottom: 1px;
}
input.editable[type="date"] { min-width: 130px; }

/* â”€â”€ Due date urgency â€” task columns only â”€â”€ */
tr.due-today .td-task-a,
tr.due-today .td-task-b  { background: rgba(220,38,38,0.22) !important; }

tr.due-urgent .td-task-a,
tr.due-urgent .td-task-b { background: rgba(220,38,38,0.12) !important; }

tr.due-soon .td-task-a,
tr.due-soon .td-task-b   { background: rgba(220,38,38,0.06) !important; }

/* Due date badge inside the cell */
.due-badge {
  display: inline-block; border-radius: 4px;
  padding: 2px 7px; font-weight: 700; font-size: 12.5px;
}
.due-badge-today  { color: #991b1b; background: rgba(220,38,38,0.15); border: 1px solid rgba(220,38,38,0.35); }
.due-badge-urgent { color: #b91c1c; background: rgba(220,38,38,0.09); border: 1px solid rgba(220,38,38,0.22); }
.due-badge-soon   { color: #c2410c; background: rgba(220,38,38,0.05); border: 1px solid rgba(220,38,38,0.15); }

.done-check { width: 18px; height: 18px; cursor: pointer; accent-color: var(--success); }

.empty-state {
  text-align: center; padding: 48px; color: var(--muted);
  font-style: italic; font-size: 14px;
}
.empty-state span { display: block; font-size: 32px; margin-bottom: 12px; }

.no-task-hint { color: var(--muted); font-style: italic; font-size: 12px; }

/* â”€â”€ Loading skeleton â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.skeleton {
  background: linear-gradient(90deg, #eaeff8 25%, #d8e2f4 50%, #eaeff8 75%);
  background-size: 200% 100%;
  animation: shimmer 1.4s infinite;
  border-radius: 4px; height: 14px; display: inline-block;
}
@keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

/* â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(10,20,50,0.55); z-index: 200;
  align-items: center; justify-content: center;
  backdrop-filter: blur(3px);
}
.modal-overlay.active { display: flex; }

.modal {
  background: var(--white); border-radius: 12px;
  padding: 32px; width: 460px; max-width: 95vw;
  box-shadow: 0 20px 60px rgba(10,20,50,0.25);
  max-height: 92vh; overflow-y: auto;
  animation: modalIn 0.2s ease;
}
@keyframes modalIn { from{opacity:0;transform:scale(0.96)translateY(8px)} to{opacity:1;transform:none} }

.modal h3 {
  font-family: 'Playfair Display', serif;
  color: var(--navy); margin-bottom: 22px; font-size: 18px;
  padding-bottom: 12px; border-bottom: 1.5px solid var(--light);
}

.form-section-label {
  font-size: 10.5px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.7px; color: var(--muted);
  margin: 20px 0 12px; padding-bottom: 6px;
  border-bottom: 1px solid var(--light);
}

.form-group { margin-bottom: 14px; }
.form-group label {
  display: block; font-weight: 600; color: var(--blue);
  font-size: 12px; margin-bottom: 5px;
}
.form-group input,
.form-group textarea,
.form-group select {
  width: 100%; padding: 9px 12px;
  border: 1.5px solid #d0daea; border-radius: 6px;
  font-family: 'Source Sans 3', sans-serif;
  font-size: 13.5px; color: var(--text);
  transition: border-color 0.2s;
  outline: none;
}
.form-group input:focus,
.form-group textarea:focus { border-color: var(--mid); }
.form-group textarea { height: 72px; resize: vertical; }
.optional { color: var(--muted); font-weight: 400; }

.modal-footer {
  display: flex; gap: 10px; justify-content: flex-end;
  margin-top: 24px; padding-top: 16px;
  border-top: 1px solid var(--light);
}

.btn-cancel { background: var(--lighter); color: var(--muted); border: 1px solid #d0daea; }
.btn-cancel:hover { background: #e0e8f4; }
</style>
</head>
<body>

<!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header>
  <div class="header-left">
    <div class="header-emblem">âš–</div>
    <div>
      <h1>Case Tracker</h1>
      <p>Click any field to edit &nbsp;â€¢&nbsp; Changes save automatically</p>
    </div>
  </div>
  <div class="header-right">
    <button class="btn btn-ghost btn-sm" onclick="showSetup()">âš™ Setup</button>
    <button class="btn btn-gold" onclick="openAddClientModal()">+ New Client</button>
  </div>
</header>

<!-- â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="toolbar">
  <div class="toolbar-group">
    <label>Sort by</label>
    <select id="sortSelect" onchange="renderTable()">
      <option value="client">Client Name</option>
      <option value="date">Due Date â€” Soonest First</option>
      <option value="date-desc">Due Date â€” Latest First</option>
    </select>
  </div>
  <div class="toolbar-group">
    <label>Filter</label>
    <input type="text" id="filterInput" placeholder="Search clientâ€¦" oninput="renderTable()" style="width:180px;">
    <button class="btn btn-primary btn-sm" onclick="document.getElementById('filterInput').value='';renderTable()">âœ•</button>
  </div>
  <div class="toolbar-right">
    <button class="btn btn-primary btn-sm" onclick="loadData()">â†º Refresh</button>
    <button class="btn btn-primary btn-sm" onclick="window.print()">ðŸ–¨ Print</button>
  </div>
</div>

<!-- â”€â”€ Status Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="statusBar">
  <div class="status-dot loading" id="statusDot"></div>
  <span id="statusText">Initializingâ€¦</span>
</div>

<!-- â”€â”€ Setup Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="setupBanner">
  <h3>âš™ Connect to Google Sheets</h3>
  <p>To save your data, paste your <strong>Google Apps Script Web App URL</strong> below and click Save.<br>
  Don't have one yet? Follow the setup instructions in your download package.</p>
  <div class="setup-url-row">
    <input type="text" id="scriptUrlInput" class="editable" style="border:1.5px solid #d0daea;border-radius:6px;padding:8px 12px;background:white;" placeholder="https://script.google.com/macros/s/â€¦/exec">
    <button class="btn btn-gold" onclick="saveScriptUrl()">Save & Connect</button>
    <button class="btn btn-cancel btn-sm" onclick="hideSetup()">Cancel</button>
  </div>
</div>

<!-- â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="container">
  <div class="table-wrap">
    <table id="caseTable">
      <thead>
        <tr class="thead-section">
          <th colspan="2" class="th-case-section">â—€ CASE INFORMATION</th>
          <th colspan="3" class="th-task-section">TO-DO TASKS â–¶</th>
          <th class="th-act-section">ACTIONS</th>
        </tr>
        <tr class="thead-cols">
          <th class="th-case">Client Name</th>
          <th class="th-case">Case Notes</th>
          <th class="th-task">Task</th>
          <th class="th-task">Due Date</th>
          <th class="th-task">Addl Details</th>
          <th class="th-act">Done / Remove</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<!-- â”€â”€ Add Client Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="clientModal">
  <div class="modal">
    <h3>New Client</h3>
    <div class="form-section-label">Case Information</div>
    <div class="form-group"><label>Client Name *</label><input type="text" id="nc_name" placeholder="e.g. Smith, John"></div>
    <div class="form-group"><label>Case Notes</label><textarea id="nc_notes" placeholder="Brief case summaryâ€¦"></textarea></div>
    <div class="form-section-label">First Task <span style="font-weight:400;text-transform:none;letter-spacing:0">(optional)</span></div>
    <div class="form-group"><label>Task</label><input type="text" id="nc_task" placeholder="e.g. Draft complaint"></div>
    <div class="form-group"><label>Due Date</label><input type="date" id="nc_due"></div>
    <div class="form-group"><label>Additional Details</label><input type="text" id="nc_details" placeholder="Any extra notesâ€¦"></div>
    <div class="modal-footer">
      <button class="btn btn-cancel" onclick="closeModal('clientModal')">Cancel</button>
      <button class="btn btn-gold" id="addClientBtn" onclick="addClient()">Add Client</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Add Task Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="taskModal">
  <div class="modal">
    <h3 id="taskModalTitle">New Task</h3>
    <div class="form-group"><label>Task *</label><input type="text" id="nt_task" placeholder="Describe the taskâ€¦"></div>
    <div class="form-group"><label>Due Date</label><input type="date" id="nt_due"></div>
    <div class="form-group"><label>Additional Details</label><textarea id="nt_details" placeholder="Any extra notesâ€¦"></textarea></div>
    <div class="modal-footer">
      <button class="btn btn-cancel" onclick="closeModal('taskModal')">Cancel</button>
      <button class="btn btn-gold" id="addTaskBtn" onclick="saveNewTask()">Add Task</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STORAGE_KEY = "caseTracker_scriptUrl";
let SCRIPT_URL = localStorage.getItem(STORAGE_KEY) || "";

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cases = [];   // [{ caseId, client, court, caseNum, judge, notes }]
let tasks = [];   // [{ taskId, caseId, task, due, details, done }]
let pendingCaseId = null;
let saving = false;

// â”€â”€ Status helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(msg, type="ok") {
  document.getElementById("statusText").textContent = msg;
  const dot = document.getElementById("statusDot");
  dot.className = "status-dot" + (type==="loading"?" loading": type==="error"?" error":"");
}

// â”€â”€ Script URL setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSetup() {
  document.getElementById("setupBanner").style.display = "block";
  document.getElementById("scriptUrlInput").value = SCRIPT_URL;
}
function hideSetup() {
  document.getElementById("setupBanner").style.display = "none";
}
function saveScriptUrl() {
  const val = document.getElementById("scriptUrlInput").value.trim();
  if (!val.startsWith("https://script.google.com")) {
    alert("That doesn't look like a valid Apps Script URL. It should start with https://script.google.com/macros/s/â€¦");
    return;
  }
  SCRIPT_URL = val;
  localStorage.setItem(STORAGE_KEY, SCRIPT_URL);
  hideSetup();
  loadData();
}

// â”€â”€ API calls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(action, body={}) {
  if (!SCRIPT_URL) throw new Error("NO_URL");
  const url = SCRIPT_URL + "?action=" + action;
  const res = await fetch(url, {
    method: "POST",
    body: JSON.stringify({ action, ...body }),
  });
  const data = await res.json();
  if (data.error) throw new Error(data.error);
  return data;
}

// â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  if (!SCRIPT_URL) {
    setStatus("Not connected â€” click âš™ Setup to connect your Google Sheet.", "error");
    showSetup();
    renderTable();
    return;
  }
  setStatus("Loadingâ€¦", "loading");
  try {
    const [casesData, tasksData] = await Promise.all([api("getCases"), api("getTasks")]);
    cases = casesData;
    // Normalize all due dates coming back from the sheet
    tasks = tasksData.map(t => ({ ...t, due: normalizeDate(t.due) }));
    setStatus(`Loaded ${cases.length} case${cases.length!==1?"s":""}, ${tasks.length} task${tasks.length!==1?"s":""}  â€¢  Last refreshed ${new Date().toLocaleTimeString()}`);
    renderTable();
  } catch(e) {
    if (e.message === "NO_URL") {
      setStatus("Not connected â€” click âš™ Setup to connect your Google Sheet.", "error");
      showSetup();
    } else {
      setStatus("Error loading data: " + e.message, "error");
    }
    renderTable();
  }
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getToday() {
  return new Date().toISOString().split("T")[0];
}
function countBusinessDays(from, to) {
  let count = 0;
  const cur = new Date(from);
  cur.setDate(cur.getDate() + 1); // start counting from tomorrow
  while (cur <= to) {
    const day = cur.getDay();
    if (day !== 0 && day !== 6) count++;
    cur.setDate(cur.getDate() + 1);
  }
  return count;
}
function dueDateClass(due) {
  if (!due) return "";
  const today = new Date(); today.setHours(0,0,0,0);
  const d = new Date(due + "T00:00:00");
  if (isNaN(d.getTime())) return "";
  const calDiff = (d - today) / 864e5;
  if (calDiff < 0) return "";               // overdue/past â€” no highlight
  if (calDiff === 0) return "due-today";
  const bizDays = countBusinessDays(today, d);
  if (bizDays <= 3) return "due-urgent";
  if (bizDays <= 5) return "due-soon";
  return "";
}
function formatDateDisplay(d) {
  if (!d) return "";
  const [y,m,day] = d.split("-");
  if (!y||!m||!day) return d;
  return `${m}/${day}/${y}`;
}
function esc(s) {
  return String(s||"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;");
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable() {
  const tbody  = document.getElementById("tableBody");
  const sort   = document.getElementById("sortSelect").value;
  const filter = document.getElementById("filterInput").value.toLowerCase();

  // Flatten: one row per task; if client has no tasks, one row still
  let rows = [];
  cases.forEach(c => {
    const myTasks = tasks.filter(t => t.caseId === c.caseId);
    if (myTasks.length === 0) {
      rows.push({ ...c, taskObj: null });
    } else {
      myTasks.forEach(t => rows.push({ ...c, taskObj: t }));
    }
  });

  // Filter
  if (filter) rows = rows.filter(r => r.client.toLowerCase().includes(filter));

  // Sort
  if (sort === "client") {
    rows.sort((a,b) => {
      const cn = a.client.localeCompare(b.client);
      if (cn) return cn;
      return (a.taskObj?.due||"9999").localeCompare(b.taskObj?.due||"9999");
    });
  } else {
    const asc = sort === "date";
    rows.sort((a,b) => {
      const da = a.taskObj?.due||"9999", db = b.taskObj?.due||"9999";
      return asc ? da.localeCompare(db) : db.localeCompare(da);
    });
  }

  // Assign alternating colors per client
  const colorMap = {};
  let ci = 0;
  rows.forEach(r => { if (!(r.caseId in colorMap)) colorMap[r.caseId] = ci++ % 2; });

  tbody.innerHTML = "";

  if (rows.length === 0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="9" class="empty-state"><span>âš–</span>${
      !SCRIPT_URL
        ? "Connect your Google Sheet via âš™ Setup, then add your first client."
        : filter
          ? "No clients match your search."
          : "No cases yet â€” click + New Client to get started."
    }</td>`;
    tbody.appendChild(tr);
    return;
  }

  rows.forEach(r => {
    const alt   = colorMap[r.caseId];
    const t     = r.taskObj;
    const done  = t?.done === "true" || t?.done === true;
    const dc    = t && !done ? dueDateClass(t.due) : "";

    const tr = document.createElement("tr");
    const trClasses = [];
    if (done) trClasses.push("task-done");
    if (dc)   trClasses.push(dc);
    if (trClasses.length) tr.className = trClasses.join(" ");

    const caseClass = alt ? "td-case-b" : "td-case-a";
    const taskClass = alt ? "td-task-b" : "td-task-a";

    // Build due date cell
    let dueCellInner = "";
    if (t) {
      const badgeClass = dc === "due-today"  ? "due-badge due-badge-today"
                       : dc === "due-urgent" ? "due-badge due-badge-urgent"
                       : dc === "due-soon"   ? "due-badge due-badge-soon"
                       : "";
      const dateDisplay = formatDateDisplay(t.due);
      if (badgeClass) {
        // Show badge label + hidden date input for editing on click
        dueCellInner = `
          <span class="${badgeClass}" title="Click to edit" style="cursor:pointer"
            onclick="this.style.display='none';this.nextElementSibling.style.display='inline-block';this.nextElementSibling.focus()">
            ${dateDisplay}
          </span>
          <input class="editable" type="date" value="${esc(t.due)}"
            style="display:none"
            onchange="patchTask('${esc(t.taskId)}','due',this.value);renderTable()"
            onblur="renderTable()">`;
      } else {
        dueCellInner = `<input class="editable" type="date" value="${esc(t.due)}" onchange="patchTask('${esc(t.taskId)}','due',this.value)">`;
      }
    }

    tr.innerHTML = `
      <td class="${caseClass} client-name-cell">
        <input class="editable" value="${esc(r.client)}" onchange="patchCase('${esc(r.caseId)}','client',this.value)">
      </td>
      <td class="${caseClass}">
        <input class="editable" value="${esc(r.notes)}" onchange="patchCase('${esc(r.caseId)}','notes',this.value)">
      </td>
      <td class="${taskClass}">
        ${t
          ? `<input class="editable" value="${esc(t.task)}" onchange="patchTask('${esc(t.taskId)}','task',this.value)">`
          : `<span class="no-task-hint">No tasks yet</span>`}
      </td>
      <td class="${taskClass}" style="text-align:center;">
        ${dueCellInner}
      </td>
      <td class="${taskClass}">
        ${t ? `<input class="editable" value="${esc(t.details)}" onchange="patchTask('${esc(t.taskId)}','details',this.value)">` : ""}
      </td>
      <td class="td-act">
        ${t ? `<input type="checkbox" class="done-check" title="Mark complete" ${done?"checked":""} onchange="toggleDone('${esc(t.taskId)}',this.checked)"> ` : ""}
        <button class="btn btn-add-task" onclick="openAddTaskModal('${esc(r.caseId)}','${esc(r.client)}')">+ Task</button>
        ${t ? ` <button class="btn btn-danger btn-sm" onclick="removeTask('${esc(t.taskId)}')">âœ•</button>` : ""}
        ${!t ? ` <button class="btn btn-danger btn-sm" onclick="removeClient('${esc(r.caseId)}','${esc(r.client)}')">Remove</button>` : ""}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// â”€â”€ Normalize date to YYYY-MM-DD string â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function normalizeDate(val) {
  if (!val) return "";
  // Already in YYYY-MM-DD format
  if (/^\d{4}-\d{2}-\d{2}$/.test(String(val))) return String(val);
  // Try parsing as a date (handles Date objects and other formats)
  try {
    const d = new Date(val);
    if (!isNaN(d.getTime())) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }
  } catch(e) {}
  return String(val);
}

// â”€â”€ Patch helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let patchDebounce = {};

function patchCase(caseId, field, value) {
  const c = cases.find(x => x.caseId === caseId);
  if (!c) return;
  c[field] = value;
  clearTimeout(patchDebounce["case_"+caseId]);
  patchDebounce["case_"+caseId] = setTimeout(async () => {
    setStatus("Savingâ€¦", "loading");
    try {
      await api("upsertCase", { ...c });
      setStatus("Saved âœ“  " + new Date().toLocaleTimeString());
    } catch(e) { setStatus("Save failed: " + e.message, "error"); }
  }, 800);
}

function patchTask(taskId, field, value) {
  const t = tasks.find(x => x.taskId === taskId);
  if (!t) return;
  // Normalize dates before saving
  const saveValue = field === "due" ? normalizeDate(value) : value;
  t[field] = saveValue;
  renderTable();
  clearTimeout(patchDebounce["task_"+taskId]);
  patchDebounce["task_"+taskId] = setTimeout(async () => {
    setStatus("Savingâ€¦", "loading");
    try {
      await api("updateTask", { taskId, [field]: saveValue });
      setStatus("Saved âœ“  " + new Date().toLocaleTimeString());
    } catch(e) { setStatus("Save failed: " + e.message, "error"); }
  }, 800);
}

// â”€â”€ Toggle done â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleDone(taskId, checked) {
  if (checked) {
    setTimeout(async () => {
      if (confirm("Mark this task complete and remove it?")) {
        await removeTask(taskId);
      } else {
        const t = tasks.find(x => x.taskId === taskId);
        if (t) t.done = "false";
        renderTable();
      }
    }, 150);
  } else {
    const t = tasks.find(x => x.taskId === taskId);
    if (t) { t.done = "false"; renderTable(); }
    try {
      await api("updateTask", { taskId, done: false });
    } catch(e) { setStatus("Save failed: " + e.message, "error"); }
  }
}

// â”€â”€ Remove task â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function removeTask(taskId) {
  setStatus("Deletingâ€¦", "loading");
  try {
    await api("deleteTask", { taskId });
    tasks = tasks.filter(x => x.taskId !== taskId);
    renderTable();
    setStatus("Task removed âœ“  " + new Date().toLocaleTimeString());
  } catch(e) {
    setStatus("Delete failed â€” please try again: " + e.message, "error");
    // Re-render to restore the item visually since delete didn't complete
    renderTable();
  }
}

// â”€â”€ Remove client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function removeClient(caseId, clientName) {
  if (!confirm(`Remove ${clientName} and all their tasks?`)) return;
  setStatus("Deletingâ€¦", "loading");
  try {
    await api("deleteCase", { caseId });
    cases = cases.filter(x => x.caseId !== caseId);
    tasks = tasks.filter(x => x.caseId !== caseId);
    renderTable();
    setStatus("Client removed âœ“  " + new Date().toLocaleTimeString());
  } catch(e) {
    setStatus("Delete failed â€” please try again: " + e.message, "error");
    renderTable();
  }
}

// â”€â”€ Add client modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddClientModal() {
  ["nc_name","nc_notes","nc_task","nc_due","nc_details"]
    .forEach(id => document.getElementById(id).value = "");
  document.getElementById("clientModal").classList.add("active");
  setTimeout(() => document.getElementById("nc_name").focus(), 50);
}

async function addClient() {
  const name  = document.getElementById("nc_name").value.trim();
  if (!name) { alert("Client Name is required."); return; }

  const btn = document.getElementById("addClientBtn");
  btn.textContent = "Savingâ€¦"; btn.disabled = true;

  try {
    const casePayload = {
      client: name,
      court: "", caseNum: "", judge: "",
      notes:   document.getElementById("nc_notes").value.trim(),
    };

    const caseRes = await api("upsertCase", casePayload);
    const caseId  = caseRes.caseId;
    cases.push({ caseId, ...casePayload });

    const taskText = document.getElementById("nc_task").value.trim();
    if (taskText) {
      const taskPayload = {
        caseId,
        task:    taskText,
        due:     normalizeDate(document.getElementById("nc_due").value),
        details: document.getElementById("nc_details").value.trim(),
      };
      const taskRes = await api("addTask", taskPayload);
      tasks.push({ taskId: taskRes.taskId, done: "false", ...taskPayload });
    }

    closeModal("clientModal");
    renderTable();
    setStatus("Client added âœ“  " + new Date().toLocaleTimeString());
  } catch(e) {
    alert("Error saving: " + e.message);
  } finally {
    btn.textContent = "Add Client"; btn.disabled = false;
  }
}

// â”€â”€ Add task modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddTaskModal(caseId, clientName) {
  pendingCaseId = caseId;
  document.getElementById("taskModalTitle").textContent = "New Task â€” " + clientName;
  ["nt_task","nt_due","nt_details"].forEach(id => document.getElementById(id).value = "");
  document.getElementById("taskModal").classList.add("active");
  setTimeout(() => document.getElementById("nt_task").focus(), 50);
}

async function saveNewTask() {
  const task = document.getElementById("nt_task").value.trim();
  if (!task) { alert("Please enter a task description."); return; }

  const btn = document.getElementById("addTaskBtn");
  btn.textContent = "Savingâ€¦"; btn.disabled = true;

  try {
    const payload = {
      caseId:  pendingCaseId,
      task,
      due:     normalizeDate(document.getElementById("nt_due").value),
      details: document.getElementById("nt_details").value.trim(),
    };
    const res = await api("addTask", payload);
    tasks.push({ taskId: res.taskId, done: "false", ...payload });
    closeModal("taskModal");
    renderTable();
    setStatus("Task added âœ“  " + new Date().toLocaleTimeString());
  } catch(e) {
    alert("Error saving: " + e.message);
  } finally {
    btn.textContent = "Add Task"; btn.disabled = false;
  }
}

// â”€â”€ Modal helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeModal(id) {
  document.getElementById(id).classList.remove("active");
}
document.querySelectorAll(".modal-overlay").forEach(el => {
  el.addEventListener("click", e => { if (e.target === el) el.classList.remove("active"); });
});

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadData();
</script>
</body>
</html>
